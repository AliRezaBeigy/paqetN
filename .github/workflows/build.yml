name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION_NAME="${TAG#v}"
            echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
            echo "Extracted version: $VERSION_NAME from tag: $TAG"
          else
            echo "version_name=0.1.0" >> $GITHUB_OUTPUT
            echo "No tag detected, using default version: 0.1.0"
          fi

      - name: Install MSYS2 MinGW toolchain
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-wget
            mingw-w64-x86_64-7zip

      - name: Cache Qt static build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: |
            qt-static
          key: qt-static-6.10.2-mingw64-${{ runner.os }}
          restore-keys: |
            qt-static-6.10.2-mingw64-${{ runner.os }}

      - name: Download Qt from release cache
        id: release-cache
        if: steps.cache-qt.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Actions cache missed, trying release asset cache..."
          if gh release download qt-cache --pattern "qt-static-6.10.2-mingw64.7z" --dir . 2>/dev/null; then
            echo "Downloaded Qt from release cache, extracting..."
            7z x qt-static-6.10.2-mingw64.7z -o. -y
            if [ -d "qt-static/lib/cmake/Qt6" ]; then
              echo "release-cache-hit=true" >> $GITHUB_OUTPUT
              echo "Qt extracted and verified successfully"
            else
              echo "release-cache-hit=false" >> $GITHUB_OUTPUT
              echo "Extraction succeeded but Qt6 cmake files not found, will rebuild"
              rm -rf qt-static
            fi
          else
            echo "release-cache-hit=false" >> $GITHUB_OUTPUT
            echo "No release cache found, will build from source"
          fi

      - name: Download and build static Qt
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        shell: msys2 {0}
        run: |
          QT_VERSION=6.10.2
          QT_SRC_DIR=qt-everywhere-src-${QT_VERSION}
          WORKSPACE_ROOT=$(pwd)
          # Convert to Windows path for CMake â€” MSYS2 paths like /d/a/...
          # get misinterpreted by CMake as literal paths (creating D:\d\a\...)
          QT_INSTALL_PREFIX=$(cygpath -w "${WORKSPACE_ROOT}/qt-static")

          wget -q https://download.qt.io/official_releases/qt/6.10/${QT_VERSION}/single/${QT_SRC_DIR}.tar.xz
          tar -xf ${QT_SRC_DIR}.tar.xz
          cd ${QT_SRC_DIR}

          # Download and extract prebuilt libclang for Clang features
          wget -q https://download.qt.io/development_releases/prebuilt/libclang/qt/libclang-release_18.1.7-based-windows-mingw_64.7z
          7z x libclang-release_18.1.7-based-windows-mingw_64.7z
          export LLVM_INSTALL_DIR=$(pwd)/libclang

          # Configure Qt for static build with optimized flags
          # Use Ninja generator for faster builds
          # Skip modules not used by the project
          ./configure -static -release -opensource -confirm-license \
            -prefix "${QT_INSTALL_PREFIX}" \
            -cmake-generator "Ninja" \
            -skip qtwebengine -skip qtmultimedia -skip qt3d -skip qtspeech -skip qtsensors -skip qtserialbus \
            -skip qtwebchannel -skip qtwebview -skip qtdoc -skip qttools -skip qttranslations \
            -skip qtcharts -skip qtlocation -skip qtpositioning -skip qtserialport \
            -skip qtbluetooth -skip qtnfc -skip qtconnectivity \
            -skip qtgraphs -skip qtgrpc -skip qtmqtt -skip qtcoap \
            -skip qtquicktimeline -skip qtlanguageserver \
            -skip qtremoteobjects -skip qtscxml -skip qtscript \
            -skip qtquick3d -skip qtquick3dphysics \
            -skip qtdatavis3d -skip qtopcua -skip qtquickeffectmaker \
            -nomake examples -nomake tests \
            -qt-zlib -qt-libpng -qt-libjpeg -qt-pcre -qt-harfbuzz -qt-freetype \
            -no-feature-system-libb2 \
            -feature-clang \
            -static-runtime \
            -optimize-size || exit 1

          # Build and install static Qt using ninja (faster than make)
          JOBS=${NUMBER_OF_PROCESSORS:-4}
          cmake --build . --parallel $JOBS || exit 1
          cmake --install . || exit 1

          # Return to workspace root
          cd "${WORKSPACE_ROOT}"

          # Verify Qt installation was successful
          if [ ! -d "qt-static/lib/cmake/Qt6" ]; then
            echo "Error: Qt installation failed - Qt6 cmake files not found"
            echo "Current directory: $(pwd)"
            echo "Contents:"
            ls -la
            exit 1
          fi

          echo "Qt installation verified successfully at $(pwd)/qt-static"

          # Clean up Qt source tree and tarball to free disk space and prevent
          # QML import scanner from picking up test files with broken QML
          rm -rf "${QT_SRC_DIR}" "${QT_SRC_DIR}.tar.xz"

          # Add static Qt to PATH
          QT_STATIC_BIN=$(cygpath -w $(pwd)/qt-static/bin)
          echo "$QT_STATIC_BIN" >> $GITHUB_PATH

      - name: Compress Qt for release cache
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        shell: msys2 {0}
        run: |
          echo "Compressing Qt static build for release cache..."
          7z a -mx=9 qt-static-6.10.2-mingw64.7z qt-static/
          ARCHIVE_SIZE=$(du -h qt-static-6.10.2-mingw64.7z | cut -f1)
          echo "Archive size: ${ARCHIVE_SIZE}"

      - name: Upload Qt to release cache
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        shell: bash
        run: |
          # Create the cache release if it doesn't exist, then upload
          if ! gh release view qt-cache &>/dev/null; then
            echo "Creating qt-cache release..."
            gh release create qt-cache \
              --title "Build Cache (Development)" \
              --notes "Prebuilt static Qt for CI. This release is used as a build cache." \
              --prerelease
          fi

          echo "Uploading Qt archive to release..."
          gh release upload qt-cache qt-static-6.10.2-mingw64.7z --clobber
          echo "Upload complete"

      - name: Setup Qt PATH (cached)
        if: steps.cache-qt.outputs.cache-hit == 'true' || steps.release-cache.outputs.release-cache-hit == 'true'
        shell: msys2 {0}
        run: |
          QT_STATIC_BIN=$(cygpath -w $(pwd)/qt-static/bin)
          echo "$QT_STATIC_BIN" >> $GITHUB_PATH

      - name: Build QuaZip statically
        shell: msys2 {0}
        run: |
          JOBS=${NUMBER_OF_PROCESSORS:-4}
          # Convert to Windows path for CMake
          QT_STATIC_DIR=$(cygpath -w "$(pwd)/qt-static")

          # Verify Qt6 is available
          if [ ! -d "qt-static/lib/cmake/Qt6" ]; then
            echo "Error: Qt6 cmake directory not found"
            echo "Contents of qt-static/lib/cmake:"
            ls -la qt-static/lib/cmake/ 2>/dev/null || echo "qt-static directory does not exist"
            exit 1
          fi

          echo "Qt6 found at ${QT_STATIC_DIR}"

          cd 3rdparty/quazip
          mkdir -p build
          cd build
          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX="${QT_STATIC_DIR}" \
            -DCMAKE_PREFIX_PATH="${QT_STATIC_DIR}" \
            -DQUAZIP_QT_MAJOR_VERSION=6
          cmake --build . --parallel $JOBS
          cmake --install .

      - name: Configure CMake for static build
        shell: msys2 {0}
        run: |
          QT_STATIC_DIR=$(cygpath -w "$(pwd)/qt-static")
          cmake -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DAPP_VERSION="${{ steps.version.outputs.version_name }}" \
            -DCMAKE_INSTALL_PREFIX=install \
            -DCMAKE_PREFIX_PATH="${QT_STATIC_DIR}" \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_EXE_LINKER_FLAGS="-static"

      - name: Build
        shell: msys2 {0}
        run: |
          JOBS=${NUMBER_OF_PROCESSORS:-4}
          cmake --build build --parallel $JOBS

      - name: Package Windows build
        if: startsWith(github.ref, 'refs/tags/')
        shell: msys2 {0}
        run: |
          mkdir -p package
          cmake --install build --config Release --prefix "$(cygpath -w "$(pwd)/package")"
          mv package/bin/apppaqetN.exe package/paqetN.exe
          echo "Single executable created: package/paqetN.exe"

      - name: Upload Windows artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: paqetN-windows
          path: package/paqetN.exe

  build-linux:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION_NAME="${TAG#v}"
            echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
            echo "Extracted version: $VERSION_NAME from tag: $TAG"
          else
            echo "version_name=0.1.0" >> $GITHUB_OUTPUT
            echo "No tag detected, using default version: 0.1.0"
          fi

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build pkg-config python3 \
            libgl1-mesa-dev libglib2.0-dev libfontconfig1-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libxcb1-dev libxcb-cursor-dev libxcb-glx0-dev \
            libxcb-keysyms1-dev libxcb-image0-dev libxcb-shm0-dev \
            libxcb-icccm4-dev libxcb-sync-dev libxcb-xfixes0-dev \
            libxcb-shape0-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-util-dev libxcb-xinerama0-dev libxcb-xkb-dev \
            libx11-xcb-dev libxext-dev libxfixes-dev libxi-dev libxrender-dev \
            libatspi2.0-dev libvulkan-dev libdrm-dev libgbm-dev \
            libwayland-dev \
            zlib1g-dev

      - name: Cache Qt static build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: |
            qt-static
          key: qt-static-6.10.2-linux-amd64-${{ runner.os }}
          restore-keys: |
            qt-static-6.10.2-linux-amd64-${{ runner.os }}

      - name: Download Qt from release cache
        id: release-cache
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          echo "Actions cache missed, trying release asset cache..."
          if gh release download qt-cache --pattern "qt-static-6.10.2-linux-amd64.tar.zst" --dir . 2>/dev/null; then
            echo "Downloaded Qt from release cache, extracting..."
            tar --zstd -xf qt-static-6.10.2-linux-amd64.tar.zst
            if [ -d "qt-static/lib/cmake/Qt6" ]; then
              echo "release-cache-hit=true" >> $GITHUB_OUTPUT
              echo "Qt extracted and verified successfully"
            else
              echo "release-cache-hit=false" >> $GITHUB_OUTPUT
              echo "Extraction succeeded but Qt6 cmake files not found, will rebuild"
              rm -rf qt-static
            fi
          else
            echo "release-cache-hit=false" >> $GITHUB_OUTPUT
            echo "No release cache found, will build from source"
          fi

      - name: Download and build static Qt
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        run: |
          QT_VERSION=6.10.2
          QT_SRC_DIR=qt-everywhere-src-${QT_VERSION}
          QT_INSTALL_PREFIX=$(pwd)/qt-static
          
          wget -q https://download.qt.io/official_releases/qt/6.10/${QT_VERSION}/single/${QT_SRC_DIR}.tar.xz
          tar -xf ${QT_SRC_DIR}.tar.xz
          cd ${QT_SRC_DIR}
          
          # Configure Qt for static build
          ./configure -static -release -opensource -confirm-license \
            -prefix "${QT_INSTALL_PREFIX}" \
            -cmake-generator "Ninja" \
            -xcb \
            -skip qtwebengine -skip qtmultimedia -skip qt3d -skip qtspeech -skip qtsensors -skip qtserialbus \
            -skip qtwebchannel -skip qtwebview -skip qtdoc -skip qttools -skip qttranslations \
            -skip qtcharts -skip qtlocation -skip qtpositioning -skip qtserialport \
            -skip qtbluetooth -skip qtnfc -skip qtconnectivity \
            -skip qtgraphs -skip qtgrpc -skip qtmqtt -skip qtcoap \
            -skip qtquicktimeline -skip qtlanguageserver \
            -skip qtremoteobjects -skip qtscxml -skip qtscript \
            -skip qtquick3d -skip qtquick3dphysics \
            -skip qtdatavis3d -skip qtopcua -skip qtquickeffectmaker \
            -nomake examples -nomake tests \
            -qt-zlib -qt-libpng -qt-libjpeg -qt-pcre -qt-harfbuzz -qt-freetype \
            -no-feature-system-libb2 \
            -optimize-size || exit 1
          
          # Build and install
          JOBS=$(nproc)
          cmake --build . --parallel $JOBS || exit 1
          cmake --install . || exit 1
          
          # Return to workspace root
          cd ..
          
          # Verify Qt installation
          if [ ! -d "qt-static/lib/cmake/Qt6" ]; then
            echo "Error: Qt installation failed - Qt6 cmake files not found"
            ls -la
            exit 1
          fi
          
          echo "Qt installation verified successfully"
          
          # Clean up source tree
          rm -rf "${QT_SRC_DIR}" "${QT_SRC_DIR}.tar.xz"

      - name: Compress Qt for release cache
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        run: |
          echo "Compressing Qt static build for release cache..."
          tar --zstd -cf qt-static-6.10.2-linux-amd64.tar.zst qt-static/
          ARCHIVE_SIZE=$(du -h qt-static-6.10.2-linux-amd64.tar.zst | cut -f1)
          echo "Archive size: ${ARCHIVE_SIZE}"

      - name: Upload Qt to release cache
        if: steps.cache-qt.outputs.cache-hit != 'true' && steps.release-cache.outputs.release-cache-hit != 'true'
        run: |
          # Create the cache release if it doesn't exist, then upload
          if ! gh release view qt-cache &>/dev/null; then
            echo "Creating qt-cache release..."
            gh release create qt-cache \
              --title "Build Cache (Development)" \
              --notes "Prebuilt static Qt for CI. This release is used as a build cache." \
              --prerelease
          fi
          
          echo "Uploading Qt archive to release..."
          gh release upload qt-cache qt-static-6.10.2-linux-amd64.tar.zst --clobber
          echo "Upload complete"

      - name: Build QuaZip statically
        run: |
          JOBS=$(nproc)
          QT_STATIC_DIR=$(pwd)/qt-static
          
          if [ ! -d "qt-static/lib/cmake/Qt6" ]; then
            echo "Error: Qt6 cmake directory not found"
            ls -la qt-static/lib/cmake/ 2>/dev/null || echo "qt-static directory does not exist"
            exit 1
          fi
          
          echo "Qt6 found at ${QT_STATIC_DIR}"
          
          cd 3rdparty/quazip
          mkdir -p build
          cd build
          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX="${QT_STATIC_DIR}" \
            -DCMAKE_PREFIX_PATH="${QT_STATIC_DIR}" \
            -DQUAZIP_QT_MAJOR_VERSION=6
          cmake --build . --parallel $JOBS
          cmake --install .

      - name: Configure CMake for static build
        run: |
          QT_STATIC_DIR=$(pwd)/qt-static
          cmake -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DAPP_VERSION="${{ steps.version.outputs.version_name }}" \
            -DCMAKE_INSTALL_PREFIX=install \
            -DCMAKE_PREFIX_PATH="${QT_STATIC_DIR}" \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"

      - name: Build
        run: |
          JOBS=$(nproc)
          cmake --build build --parallel $JOBS

      - name: Package Linux build
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p package
          cmake --install build --config Release --prefix "$(pwd)/package"
          mv package/bin/apppaqetN package/paqetN
          strip package/paqetN
          chmod +x package/paqetN
          echo "Single executable created: package/paqetN"
          ls -lh package/paqetN

      - name: Upload Linux artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: paqetN-linux
          path: package/paqetN

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [ build-windows, build-linux ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: paqetN-windows
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: paqetN-linux
          path: artifacts/linux

      - name: Create GitHub Release
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          
          echo "Creating release ${TAG} with artifacts:"
          ls -lhR artifacts/
          
          gh release create "${TAG}" \
            --repo "${{ github.repository }}" \
            --title "paqetN ${VERSION}" \
            --generate-notes \
            artifacts/windows/paqetN.exe#paqetN-${VERSION}-windows-amd64.exe \
            artifacts/linux/paqetN#paqetN-${VERSION}-linux-amd64
